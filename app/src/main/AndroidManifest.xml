<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools">

    <!-- ====================================================================
         SMS PERMISSIONS (all public SDK permissions)
         ==================================================================== -->

    <!-- Send SMS messages -->
    <uses-permission android:name="android.permission.SEND_SMS" />

    <!-- Receive incoming SMS (for default SMS app) -->
    <uses-permission android:name="android.permission.RECEIVE_SMS" />

    <!-- Read SMS from system provider -->
    <uses-permission android:name="android.permission.READ_SMS" />

    <!-- Write SMS to system provider (default SMS app requirement) -->
    <uses-permission android:name="android.permission.WRITE_SMS"
        tools:ignore="ProtectedPermissions" />

    <!-- ====================================================================
         MMS PERMISSIONS
         ==================================================================== -->

    <!-- Receive MMS messages -->
    <uses-permission android:name="android.permission.RECEIVE_MMS" />

    <!-- Receive WAP push for MMS notifications -->
    <uses-permission android:name="android.permission.RECEIVE_WAP_PUSH" />

    <!-- ====================================================================
         CONTACTS & PHONE STATE
         ==================================================================== -->

    <!-- Read contacts for display names -->
    <uses-permission android:name="android.permission.READ_CONTACTS" />

    <!-- Phone state for subscription info -->
    <uses-permission android:name="android.permission.READ_PHONE_STATE" />

    <!-- Phone numbers (API 26+) -->
    <uses-permission android:name="android.permission.READ_PHONE_NUMBERS" />

    <!-- ====================================================================
         NETWORK & STORAGE (for MMS)
         ==================================================================== -->

    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
    <uses-permission android:name="android.permission.CHANGE_NETWORK_STATE" />

    <!-- Storage permissions for MMS attachments (images, videos, audio) -->
    <!-- Android 13+ (API 33+) granular media permissions -->
    <uses-permission android:name="android.permission.READ_MEDIA_IMAGES" />
    <uses-permission android:name="android.permission.READ_MEDIA_VIDEO" />
    <uses-permission android:name="android.permission.READ_MEDIA_AUDIO" />

    <!-- Android 10-12 (API 29-32) legacy storage permission -->
    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"
        android:maxSdkVersion="32" />

    <!-- Camera permission for taking photos directly (optional, can use external camera app) -->
    <uses-permission android:name="android.permission.CAMERA" />

    <!-- ====================================================================
         NOTIFICATIONS & FOREGROUND SERVICE
         ==================================================================== -->

    <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />
    <uses-permission android:name="android.permission.VIBRATE" />
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE_SPECIAL_USE" />

    <!-- Battery optimization exemption (for continuous Matrix sync) -->
    <uses-permission android:name="android.permission.REQUEST_IGNORE_BATTERY_OPTIMIZATIONS" />

    <!-- ====================================================================
         FEATURE DECLARATIONS
         ==================================================================== -->

    <!-- Device must have telephony -->
    <uses-feature
        android:name="android.hardware.telephony"
        android:required="true" />

    <!-- ====================================================================
         APPLICATION
         ==================================================================== -->

    <application
        android:name="com.technicallyrural.junction.app.JunctionApplication"
        android:allowBackup="true"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:roundIcon="@mipmap/ic_launcher_round"
        android:supportsRtl="true"
        android:theme="@style/Theme.Junction"
        tools:targetApi="34">

        <!-- ================================================================
             MAIN ACTIVITY (app module)
             ================================================================ -->

        <activity
            android:name=".ui.MainActivity"
            android:exported="true"
            android:launchMode="singleTop">

            <!-- Main launcher entry -->
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>

            <!-- Handle SENDTO intents (compose new message) -->
            <intent-filter>
                <action android:name="android.intent.action.SENDTO" />
                <category android:name="android.intent.category.DEFAULT" />
                <data android:scheme="sms" />
                <data android:scheme="smsto" />
                <data android:scheme="mms" />
                <data android:scheme="mmsto" />
            </intent-filter>

            <!-- Handle VIEW intents for SMS URIs -->
            <intent-filter>
                <action android:name="android.intent.action.VIEW" />
                <category android:name="android.intent.category.DEFAULT" />
                <category android:name="android.intent.category.BROWSABLE" />
                <data android:scheme="sms" />
                <data android:scheme="smsto" />
                <data android:scheme="mms" />
                <data android:scheme="mmsto" />
            </intent-filter>
        </activity>

        <!-- ================================================================
             MATRIX CONFIGURATION ACTIVITY (app module)
             ================================================================ -->

        <activity
            android:name=".ui.MatrixConfigActivity"
            android:exported="false"
            android:label="Matrix Configuration"
            android:parentActivityName=".ui.MainActivity">
            <meta-data
                android:name="android.support.PARENT_ACTIVITY"
                android:value=".ui.MainActivity" />
        </activity>

        <!-- ================================================================
             MATRIX SYNC SERVICE (app module)
             ================================================================ -->

        <service
            android:name=".service.MatrixSyncService"
            android:enabled="true"
            android:exported="false"
            android:foregroundServiceType="specialUse">
            <property
                android:name="android.app.PROPERTY_SPECIAL_USE_FGS_SUBTYPE"
                android:value="Real-time Matrix bridge for SMS synchronization" />
        </service>

        <!-- ================================================================
             SMS/MMS RECEIVERS (app module)
             ================================================================ -->

        <!-- Primary SMS receiver for Matrix bridging (INBOUND)
             This receiver intercepts SMS_DELIVER before AOSP processing,
             enabling SMS → Matrix forwarding while maintaining normal
             SMS storage and UI functionality via CoreSmsRegistry listener. -->
        <receiver
            android:name=".receiver.SmsDeliverReceiver"
            android:exported="true"
            android:permission="android.permission.BROADCAST_SMS">
            <intent-filter>
                <action android:name="android.provider.Telephony.SMS_DELIVER" />
            </intent-filter>
        </receiver>

        <!-- SMS/MMS send status receiver for Matrix bridging (OUTBOUND)
             This receiver intercepts MESSAGE_SENT_ACTION callbacks after
             successful carrier transmission, enabling outbound SMS → Matrix
             bridging. Runs in parallel with AOSP's SendStatusReceiver. -->
        <receiver
            android:name=".receiver.SmsSentStatusReceiver"
            android:exported="false" />

        <!-- Boot receiver for unbridged message recovery
             Scans AOSP database on boot for sent messages that weren't
             bridged due to crashes, ensuring eventual consistency. -->
        <receiver
            android:name=".receiver.MatrixBridgeBootReceiver"
            android:exported="true">
            <intent-filter>
                <action android:name="android.intent.action.BOOT_COMPLETED" />
            </intent-filter>
        </receiver>

        <!-- All sms-upstream components (activities, receivers, services,
             providers) are declared in sms-upstream/src/main/AndroidManifest.xml
             and merged automatically by the Android Gradle Plugin. -->

    </application>

</manifest>
